# read


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

### Ideas

- Create classes to represent Data, Metadata, and Dataset? (dataset
  being the combination of the two, with fns which link them; ie. for
  cross-checking the type defined in meta is what the data type actually
  is)
- For Meta, can be read in different formats, and then exported in
  different formats
  - For dataset, meta must be a particular format
- Filter out rows with all nulls

``` python
RAW_DATA = Path("../data/raw")
PROCESSED_DATA = Path("../data/processed")
df, meta = pyspssio.read_sav(RAW_DATA/"G214_PQ.sav")
df = pl.from_pandas(df)
```

------------------------------------------------------------------------

<a
href="https://github.com/matt-humphrey/pain/blob/main/pain/read.py#L28"
target="_blank" style="float:right; font-size:smaller">source</a>

### Metadata

>  Metadata (variable_basename:str, label:str, field_values:dict[int,str],
>                field_type:str, field_width:int, decimals:int,
>                variable_type:str)

Test this works as expected

``` python
Metadata(
    variable_basename = "PN17",
    label = "Ever had back pain",
    field_values = {-99: "Missing", 0: "No", 1: "Yes"},
    field_type = "Numeric",
    field_width = 3,
    decimals =  0,
    variable_type = "Nominal"
)
```

    Metadata(variable_basename='PN17', label='Ever had back pain', field_values={-99: 'Missing', 0: 'No', 1: 'Yes'}, field_type='Numeric', field_width=3, decimals=0, variable_type='Nominal')

------------------------------------------------------------------------

<a
href="https://github.com/matt-humphrey/pain/blob/main/pain/read.py#L57"
target="_blank" style="float:right; font-size:smaller">source</a>

### reformat_metadata

>  reformat_metadata (m:pyreadstat._readstat_parser.metadata_container)

*Reformat metadata into a more readable and consistent format*

<table>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>m</td>
<td>metadata_container</td>
<td>metadata from pyreadstat</td>
</tr>
<tr>
<td><strong>Returns</strong></td>
<td><strong>dict</strong></td>
<td></td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/matt-humphrey/pain/blob/main/pain/read.py#L38"
target="_blank" style="float:right; font-size:smaller">source</a>

### unpack_variable_types

>  unpack_variable_types (input_dict)

*â€¦*

TODO: add Data and Metadata classes, and nest them in the Dataset class

------------------------------------------------------------------------

<a
href="https://github.com/matt-humphrey/pain/blob/main/pain/read.py#L72"
target="_blank" style="float:right; font-size:smaller">source</a>

### read_sav

>  read_sav (data_dir:str|pathlib.Path, file:str,
>                cols:Optional[list[str]]=None)

------------------------------------------------------------------------

<a
href="https://github.com/matt-humphrey/pain/blob/main/pain/read.py#L82"
target="_blank" style="float:right; font-size:smaller">source</a>

### Dataset

>  Dataset (file:str, data_dir:str|pathlib.Path, prefix:Optional[str]=None,
>               variables:Optional[list[str]]=None)

``` python
df, meta = Dataset("G214_PQ.sav", RAW_DATA).load_data()
```

``` python
datasets = [
    Dataset("G214_PQ.sav", RAW_DATA, "G214_PQ_", ["ID", "G214_PQ_PN17", "G214_PQ_PN25", "G214_PQ_PN34", "G214_PQ_PN35", "G214_PQ_PN36"]),
    Dataset("G214_SQ.sav", RAW_DATA, "G214_SQ_", ["ID", "G214_SQ_PN17", "G214_SQ_PN25", "G214_SQ_PN34", "G214_SQ_PN35", "G214_SQ_PN36"]),
    Dataset("G217_PQ.sav", RAW_DATA, "G217_PQ_", ["ID", "G217_PQ_PN17", "G217_PQ_PN25", "G217_PQ_PN34", "G217_PQ_PN35", "G217_PQ_PN36", "G217_PQ_PN38", "G217_PQ_PN9"]),
    Dataset("G217_SQ.sav", RAW_DATA, "G217_SQ_", ["ID", "G217_SQ_PN17", "G217_SQ_PN25", "G217_SQ_PN34", "G217_SQ_PN35", "G217_SQ_PN36", "G217_SQ_PN38", "G217_SQ_PN9"])
]
```

------------------------------------------------------------------------

<a
href="https://github.com/matt-humphrey/pain/blob/main/pain/read.py#L114"
target="_blank" style="float:right; font-size:smaller">source</a>

### combine_dataframes

>  combine_dataframes (dataframes:list[polars.lazyframe.frame.LazyFrame])

*Take a list of dataframes and return a single, combined dataframe.*

------------------------------------------------------------------------

<a
href="https://github.com/matt-humphrey/pain/blob/main/pain/read.py#L100"
target="_blank" style="float:right; font-size:smaller">source</a>

### read_and_filter_data

>  read_and_filter_data (datasets:list[__main__.Dataset])

*Take a list of
[`Dataset`](https://matt-humphrey.github.io/pain/read.html#dataset)s and
return a list of the respective dataframes and metadata for each
dataset, filtered for the given columns.*

``` python
dataframes, metadata = read_and_filter_data(datasets)
df = combine_dataframes(dataframes)
```

------------------------------------------------------------------------

<a
href="https://github.com/matt-humphrey/pain/blob/main/pain/read.py#L126"
target="_blank" style="float:right; font-size:smaller">source</a>

### merge_dictionaries

>  merge_dictionaries (dicts:list[dict[str,typing.Any]])

*Merge a series of nested dictionaries.*

``` python
meta_merged = merge_dictionaries(metadata)
```

## Writing Files

------------------------------------------------------------------------

<a
href="https://github.com/matt-humphrey/pain/blob/main/pain/read.py#L140"
target="_blank" style="float:right; font-size:smaller">source</a>

### convert_metadata_list_to_dict

>  convert_metadata_list_to_dict (metadata:list[__main__.Metadata], p:str)

*Take a list of Metadata objects and convert them into the SPSS format
with parameters as parents and variables as children, in nested
dictionaries.*

<table>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>metadata</td>
<td>list</td>
<td>list of Metadata objects</td>
</tr>
<tr>
<td>p</td>
<td>str</td>
<td>Prefix for dataset</td>
</tr>
<tr>
<td><strong>Returns</strong></td>
<td><strong>dict</strong></td>
<td></td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/matt-humphrey/pain/blob/main/pain/read.py#L158"
target="_blank" style="float:right; font-size:smaller">source</a>

### pack_variable_types

>  pack_variable_types (m:dict[dict[str,typing.Any]])

*Convert metadata parameters related to variable format into an
appropriate schema for pyreadstat.*

<table>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>m</td>
<td>dict</td>
<td>metadata in nested dictionary format</td>
</tr>
<tr>
<td><strong>Returns</strong></td>
<td><strong>dict</strong></td>
<td></td>
</tr>
</tbody>
</table>

``` python
ft = {
    'G214_PQ_PN17': 'Numeric',
    'G214_PQ_DNWN': 'Date',
    'G214_PQ_HOC1': 'String'
}

fw = {
    'G214_PQ_PN17': 3,
    'G214_PQ_DNWN': 8,
    'G214_PQ_HOC1': 8
}

d = {
    'G214_PQ_PN17': 0,
    'G214_PQ_DNWN': 0,
    'G214_PQ_HOC1': 0
}

m = {
    "Field Type": ft,
    "Field Width": fw,
    "Decimals": d
}

expected_output = {
    'G214_PQ_PN17': "F3",
    'G214_PQ_DNWN': "DATE8",
    'G214_PQ_HOC1': "A8"
}

test_eq(pack_variable_types(m), expected_output)
```

------------------------------------------------------------------------

<a
href="https://github.com/matt-humphrey/pain/blob/main/pain/read.py#L201"
target="_blank" style="float:right; font-size:smaller">source</a>

### write_sav

>  write_sav (dst_path:str|pathlib.Path,
>                 df:polars.lazyframe.frame.LazyFrame,
>                 metadata:dict[str,dict[str,typing.Any]])

*Save dataset to SPSS using `pyreadstat` library.*

<table>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>dst_path</td>
<td>str | pathlib.Path</td>
<td>path to save output file</td>
</tr>
<tr>
<td>df</td>
<td>LazyFrame</td>
<td>raw data</td>
</tr>
<tr>
<td>metadata</td>
<td>dict</td>
<td>corresponding metadata</td>
</tr>
<tr>
<td><strong>Returns</strong></td>
<td><strong>None</strong></td>
<td></td>
</tr>
</tbody>
</table>

Verify that the custom SPSS writing function makes no unintended
changes.

``` python
# Read dataset
G214_PQ = Dataset("G214_PQ.sav", RAW_DATA)
df1, meta1 = G214_PQ.load_data()

# Write the dataset unchanged to a new file
write_sav(PROCESSED_DATA/"G214_PQ.sav", df1, meta1)

# Read that newly saved file
output = Dataset("G214_PQ.sav", PROCESSED_DATA)
df2, meta2 = output.load_data()

# Compare for both data and metadata to verify no unintended changes have been introduced
assert_frame_equal(df1, df2)
test_eq(meta1, meta2)
```
